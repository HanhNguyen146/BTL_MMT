<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Chat App (Hybrid P2P Client)</title>
<style>
/* === Giao di·ªán t·ªïng th·ªÉ === */
body {
    font-family: "Segoe UI", Arial, sans-serif;
    margin: 0;
    background: #e8ecf3;
    display: flex;
    flex-direction: column;
    align-items: center;
}
h1 {
    margin-top: 20px;
    color: #222;
}
.container {
    display: flex;
    gap: 20px;
    margin: 20px;
    width: 90%;
    max-width: 1100px;
}

/* === Sidebar === */
.sidebar {
    width: 280px;
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
}
.sidebar h3 {
    margin-bottom: 10px;
    color: #444;
}
#peer-list {
    list-style: none;
    padding-left: 0;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: #fafafa;
    max-height: 200px;
    overflow-y: auto;
}
#peer-list li {
    padding: 8px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 500;
}
#peer-list li:hover { background-color: #eef3ff; }

.chat-action-btn {
    background-color: #007bff;
    border: none;
    border-radius: 5px;
    color: white;
    padding: 4px 6px;
    font-size: 10px;
    cursor: pointer;
}
.chat-action-btn:hover { background-color: #0056b3; }

#log-box {
    margin-top: 10px;
    width: 100%;
    height: 180px;
    resize: none;
    background: #f7f7f7;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 11px;
    padding: 5px;
}

/* === Main Chat === */
.main-chat {
    flex-grow: 1;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    padding: 20px;
    display: flex;
    flex-direction: column;
}
#chat-box {
    background: #fdfdfd;
    border: 1px solid #ddd;
    padding: 10px;
    overflow-y: auto;
    height: 180px;
    border-radius: 6px;
    font-family: monospace;
    font-size: 12px;
}
#private-chat-area {
    flex-grow: 1;
    border: 1px solid #ccc;
    border-radius: 6px;
    margin-top: 10px;
    padding: 10px;
    overflow-y: auto;
    background: #eef6ff;
}

/* === Form chat input === */
.chat-input-area {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}
input[type="text"] {
    flex-grow: 1;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
}
button {
    padding: 9px 15px;
    border: none;
    border-radius: 6px;
    background-color: #28a745;
    color: white;
    cursor: pointer;
    transition: background 0.2s ease;
}
button:hover { background-color: #218838; }
#register-btn { background-color: #38488f; }
#register-btn:hover { background-color: #2e3570; }
#refresh-peers { margin-top: 10px; background-color: #17a2b8; }
#refresh-peers:hover { background-color: #117a8b; }

#chat-status {
    color: green;
    font-weight: bold;
    margin-left: 10px;
}
.active-chat-indicator { color: red; font-weight: bold; }
</style>
</head>
<body>

<h1>üí¨ Chat App (P2P Client)</h1>

<div style="margin-top:10px;">
    <label for="username"><strong>Your Name:</strong></label>
    <input type="text" id="username" value="Client_Web" style="padding:6px;">
    <button id="register-btn">Register (Call /add-list)</button>
    <span id="chat-status"></span>
</div>

<div class="container">
    <div class="sidebar">
        <h3>Peers Online</h3>
        <ul id="peer-list"></ul>
        <button id="refresh-peers">üîÅ Refresh List</button>

        <h3 style="margin-top:15px;">Log Console</h3>
        <textarea id="log-box" readonly></textarea>
    </div>

    <div class="main-chat">
        <h3>Broadcast Channel</h3>
        <div id="chat-box"></div>

        <h3 style="margin-top:15px;">Private Chat: 
            <span id="current-peer-name" style="color:blue;">(None)</span>
        </h3>
        <div id="private-chat-area"></div>

        <div class="chat-input-area">
            <input type="text" id="message" placeholder="Type message...">
            <button id="send-message-btn">Send</button>
        </div>
    </div>
</div>

<!-- === Script logic gi·ªØ nguy√™n g·ªëc === -->
<script>
// (To√†n b·ªô ph·∫ßn JS gi·ªØ nguy√™n y h·ªát b·∫£n g·ªëc)
const chatBox = document.getElementById("chat-box");
const privateChatArea = document.getElementById("private-chat-area");
const currentPeerNameEl = document.getElementById("current-peer-name");
const logBox = document.getElementById("log-box");
const messageInput = document.getElementById("message");
const sendMessageBtn = document.getElementById("send-message-btn");
const peerListEl = document.getElementById("peer-list");
const registerBtn = document.getElementById("register-btn");
const usernameInput = document.getElementById("username");
const refreshPeersBtn = document.getElementById("refresh-peers");

let clientInfo = { user: "", host: "127.0.0.1", port: 0 }; 
let lastMessageCount = 0;
let isRegistered = false;

// Tr·∫°ng th√°i: L∆∞u tr·ªØ peer hi·ªán t·∫°i ƒë·ªÉ g·ª≠i tin nh·∫Øn ri√™ng
let currentPrivatePeer = null; 

function log(msg) {
    logBox.value += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
    logBox.scrollTop = logBox.scrollHeight;
}

function appendMessage(targetBox, user, msg, isSystem = false) {
    const div = document.createElement("div");
    const prefix = isSystem ? "SYSTEM" : user;
    div.innerHTML = `<strong>[${prefix}]</strong> ${msg}`;
    targetBox.appendChild(div);
    targetBox.scrollTop = targetBox.scrollHeight;
}

// --- API 1: ƒêƒÉng k√Ω (Register) ---
async function addSelfToList() {
    clientInfo.user = usernameInput.value;
    if (!clientInfo.user) return;

    const body = { user: clientInfo.user, item: "ONLINE", host: clientInfo.host, port: 0 }; // Port 0 v√¨ l√† Web Client
    
    try {
        const response = await fetch("/add-list", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        // --- DEBUG ---
        const responseData = await response.json(); // Server tr·∫£ v·ªÅ JSON
        log(`DEBUG /add-list status: ${response.status}, response: ${JSON.stringify(responseData)}`);
        // --- END DEBUG ---

        log(`Registered as ${clientInfo.user}. Starting refresh loop.`);
        isRegistered = true;
        document.getElementById("chat-status").textContent = ` (ƒê√£ ƒëƒÉng k√Ω)`;
        
        refreshPeers();
        setInterval(refreshData, 3000); 

    } catch(e) {
        log(`ERROR: Could not register with Tracker: ${e}`);
    }
}

// --- API 2: L·∫•y d·ªØ li·ªáu (Chat Board Public v√† Peers) ---
async function refreshData() {
    if (!isRegistered) return;

    let res;
    try {
        res = await fetch("/get-list");
        if (!res.ok) { 
            // Th√™m log chi ti·∫øt khi l·ªói
            log(`ERROR: Tracker fetch failed. Status: ${res.status}`); 
            return; 
        }
        
        const data = await res.json();
        
        // 1. C·∫¨P NH·∫¨T CHAT BOX CHUNG (Message Board Public)
        if (data.list.length > lastMessageCount) {
            
            // --- DEBUG ---
            // Ch·ªâ log khi c√≥ d·ªØ li·ªáu m·ªõi ƒë·ªÉ tr√°nh spam log
            log(`DEBUG /get-list: Found new data. Total items: ${data.list.length}`);
            // --- END DEBUG ---

            // X√≥a v√† v·∫Ω l·∫°i Chat Box (ƒê∆°n gi·∫£n nh·∫•t cho Polling)
            chatBox.innerHTML = "";
            let uniqueUsers = new Set();
            
            data.list.forEach(entry => {
                // Ch·ªâ hi·ªÉn th·ªã tin nh·∫Øn (item kh√°c ONLINE)
                if (entry.item !== "ONLINE") { 
                    appendMessage(chatBox, entry.user, entry.item);
                }
                uniqueUsers.add(entry.user);
            });
            lastMessageCount = data.list.length; 
            
            // 2. C·∫¨P NH·∫¨T PEER LIST V√Ä USERS
            peerListEl.innerHTML = "";
            uniqueUsers.forEach(user => {
                // Ch·ªâ hi·ªÉn th·ªã peer kh√°c m√¨nh
                if (user !== clientInfo.user) {
                    const li = document.createElement("li");
                    li.textContent = user;
                    // --- N√∫t Chat Ri√™ng ---
                    const chatBtn = document.createElement("button");
                    chatBtn.textContent = "Chat";
                    chatBtn.className = "chat-action-btn";
                    chatBtn.onclick = () => activatePrivateChat(user);
                    li.appendChild(chatBtn);
                    
                    // --- (M·ªöI) N√∫t xem log ---
                    const logBtn = document.createElement("button");
                    logBtn.textContent = "Log"; 
                    logBtn.className = "chat-action-btn";
                    logBtn.style.backgroundColor = "#6c757d";
                    logBtn.onclick = () => loadChatLog(user);
                    li.appendChild(logBtn);
                    
                    // --- N√∫t Connect ---
                    const connectBtn = document.createElement("button");
                    connectBtn.textContent = "Connect";
                    connectBtn.className = "chat-action-btn";
                    connectBtn.style.backgroundColor = "#28a745";
                    connectBtn.onclick = () => connectToPeer(user);
                    li.appendChild(connectBtn);

                    
                    peerListEl.appendChild(li);
                }
            });
        }
    } catch(e) {
        log(`ERROR /get-list failed: ${e}`);
    }
}

// --- LOGIC CHAT RI√äNG ---
function activatePrivateChat(peerName) {
    currentPrivatePeer = peerName;
    currentPeerNameEl.textContent = peerName;
    
    // X√≥a n·ªôi dung chat c≈©
    privateChatArea.innerHTML = "";
    appendMessage(privateChatArea, "SYSTEM", `Bong b√≥ng chat ri√™ng v·ªõi ${peerName} ƒë∆∞·ª£c k√≠ch ho·∫°t.`);
}

// --- (TH√äM H√ÄM N√ÄY) ---
// H√†m n√†y ƒë∆∞·ª£c g·ªçi b·ªüi n√∫t "Refresh List"
function refreshPeers() {
    log("Manual refresh triggered.");
    refreshData();
}
// --- (H·∫æT PH·∫¶N TH√äM) ---


// --- G·ª≠i tin nh·∫Øn (Private ho·∫∑c Broadcast) ---
async function sendMessage() {
    const msg = messageInput.value.trim();
    if (!msg || !isRegistered) return;

    if (currentPrivatePeer) {
        // --- G·ª≠i RI√äNG (Private Chat) ---
        log(`Sending private message to ${currentPrivatePeer}...`);
        const body = { from: clientInfo.user, to: currentPrivatePeer, message: msg };
        
        // T√°i s·ª≠ d·ª•ng logic send-peer
        const response = await fetch("/send-peer", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(body)
        });
        
        // --- DEBUG ---
        const responseData = await response.text(); // Server tr·∫£ v·ªÅ HTML
        log(`DEBUG /send-peer status: ${response.status}, response: ${responseData}`);
        // --- END DEBUG ---

        // Ghi l·∫°i trong bong b√≥ng chat
        appendMessage(privateChatArea, "You", msg);
        
    } else {
        // --- G·ª≠i CHUNG (Broadcast Channel) ---
        log("Sending broadcast message...");
        const body = { from: clientInfo.user, message: msg };
        
        // T√°i s·ª≠ d·ª•ng logic broadcast-peer
        const response = await fetch("/broadcast-peer", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(body)
        });
        
        // --- DEBUG ---
        const responseData = await response.text(); // Server tr·∫£ v·ªÅ HTML
        log(`DEBUG /broadcast-peer status: ${response.status}, response: ${responseData}`);
        // --- END DEBUG ---
        
        // Ghi l·∫°i trong chat box chung
        appendMessage(chatBox, "You", msg);
    }
    
    messageInput.value = "";
    refreshData(); // C·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c
}

// --- (M·ªöI) H√†m hi·ªÉn th·ªã l·ªãch s·ª≠ tin nh·∫Øn c·ªßa peer ---
async function loadChatLog(peerName) {
    try {
        // --- G·ª≠i request l·∫•y log c·ªßa peer ƒë∆∞·ª£c ch·ªçn ---
        const response = await fetch("/get-chat-log", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ peer: peerName })
        });
        const data = await response.json();

        const chatArea = document.getElementById("private-chat-area");
        chatArea.innerHTML = "";

        if (!data.messages || data.messages.length === 0) {
            chatArea.innerHTML = `<i>Kh√¥ng t√¨m th·∫•y tin nh·∫Øn gi·ªØa ${clientInfo.user} v√† ${peerName}</i>`;
            return;
        }

        // ‚úÖ L·ªçc ch·ªâ nh·ªØng tin c√≥ li√™n quan ƒë·∫øn m√¨nh, peer ho·∫∑c broadcast
        const filtered = data.messages.filter(msg => {
            const content = msg.content || "";
            return (
                content.includes(clientInfo.user) ||
                content.includes(peerName) ||
                content.includes("(broadcast)")
            );
        });

        // --- Hi·ªÉn th·ªã tin nh·∫Øn ---
        filtered.forEach(msg => {
            const div = document.createElement("div");
            div.style.padding = "6px";
            div.style.marginBottom = "4px";
            div.style.borderRadius = "6px";
            div.style.fontFamily = "monospace";
            div.style.textAlign = "left";

            const content = msg.content || "";
            let role = msg.direction; // m·∫∑c ƒë·ªãnh

            // === Ph√¢n lo·∫°i vai tr√≤ (SEND / RECV) theo g√≥c nh√¨n c·ªßa ch√≠nh m√¨nh ===
            if (content.includes("(broadcast)")) {
                // Broadcast: n·∫øu d√≤ng c√≥ "Broadcasted:" -> m√¨nh g·ª≠i, n·∫øu "From" -> m√¨nh nh·∫≠n
                if (content.includes("Broadcasted:")) role = "send";
                else if (content.includes("From")) role = "recv";
            } 
            else if (content.includes(`To ${peerName}`) && msg.direction === "send") {
                // m√¨nh g·ª≠i ri√™ng cho peer kia
                role = "send";
            } 
            else if (content.includes(`From ${peerName}`) && msg.direction === "recv") {
                // m√¨nh nh·∫≠n t·ª´ peer kia
                role = "recv";
            } 
            else if (content.includes(`To ${clientInfo.user}`)) {
                // peer g·ª≠i ri√™ng cho m√¨nh
                role = "recv";
            } 
            else if (content.includes(`From ${clientInfo.user}`)) {
                // m√¨nh g·ª≠i ri√™ng (tr∆∞·ªùng h·ª£p m√¨nh ƒëang xem log ch√≠nh m√¨nh)
                role = "send";
            }

            // === G√°n m√†u theo role ===
            if (role === "recv") {
                div.style.background = "#d1e7dd"; // xanh nh·∫°t
            } else if (role === "send") {
                div.style.background = "#f8d7da"; // ƒë·ªè nh·∫°t
            } else {
                div.style.background = "#e2e3e5";
            }

            // === Hi·ªÉn th·ªã n·ªôi dung ===
            div.innerHTML = `<b>[${role.toUpperCase()}]</b> ${msg.content}
                             <span style="font-size:10px;color:gray">(${msg.timestamp})</span>`;
            chatArea.appendChild(div);
            chatArea.appendChild(document.createElement("br"));
        });

        // --- SYSTEM message ---
        const systemLabel =
            clientInfo.user === peerName
                ? `Hi·ªÉn th·ªã l·ªãch s·ª≠ tin nh·∫Øn c·ªßa ch√≠nh b·∫°n (${clientInfo.user})`
                : `Hi·ªÉn th·ªã l·ªãch s·ª≠ tin nh·∫Øn gi·ªØa ${clientInfo.user} v√† ${peerName}`;
        appendMessage(chatArea, "SYSTEM", systemLabel);

    } catch (err) {
        console.error(err);
        alert("L·ªói khi t·∫£i l·ªãch s·ª≠ tin nh·∫Øn!");
    }
}
// --- (M·ªöI) H√†m Connect th·ªß c√¥ng gi·ªØa 2 peer ---
async function connectToPeer(peerName) {
    if (!clientInfo.user) {
        alert("B·∫°n c·∫ßn ƒëƒÉng k√Ω tr∆∞·ªõc khi k·∫øt n·ªëi!");
        return;
    }

    log(`Connecting ${clientInfo.user} ‚Üí ${peerName} ...`);

    try {
        const body = { from_user: clientInfo.user, to_peer: peerName };
        const response = await fetch("/connect-peer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        const data = await response.json();
        if (response.ok) {
            log(`‚úÖ Connected to ${peerName}: ${JSON.stringify(data)}`);
            alert(`‚úÖ K·∫øt n·ªëi th√†nh c√¥ng v·ªõi ${peerName}`);
        } else {
            log(`‚ùå Connect failed: ${data.error || response.statusText}`);
            alert(`‚ùå L·ªói khi k·∫øt n·ªëi: ${data.error || response.statusText}`);
        }
    } catch (e) {
        log(`‚ùå Connect request error: ${e}`);
        alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn backend!");
    }
}


// --- Event listeners ---
registerBtn.addEventListener("click", addSelfToList);
sendMessageBtn.addEventListener("click", sendMessage);
refreshPeersBtn.addEventListener("click", refreshPeers); // Gi·ªù h√†m n√†y ƒë√£ t·ªìn t·∫°i

// T·∫Øt Enter m·∫∑c ƒë·ªãnh v√† d√πng Enter ƒë·ªÉ g·ª≠i
messageInput.addEventListener("keypress", (e) => {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// Kh·ªüi t·∫°o ban ƒë·∫ßu
window.onload = () => {
    log("Client initialized. Click 'Register' to connect to Tracker.");
};
</script>

</body>
</html>
